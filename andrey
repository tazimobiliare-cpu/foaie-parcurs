import streamlit as st
import pandas as pd
import os
from datetime import datetime

# 1. Configurare PaginÄƒ
st.set_page_config(page_title="Foaie Parcurs 2026", page_icon="ğŸš—")

# 2. Definire fiÈ™ier de date
FISIER_DATE = "foaie_parcurs.csv"

# 3. FuncÈ›ie pentru salvarea datelor
def adauga_inregistrare(data, km_s, traseu, km_f):
    # CreÄƒm un tabel (DataFrame) cu noua linie
    noua_linie = pd.DataFrame([[data, km_s, traseu, km_f]], 
                              columns=["Data", "KM Start", "Traseu", "KM Final"])
    
    # DacÄƒ fiÈ™ierul nu existÄƒ, Ã®l creÄƒm acum
    if not os.path.isfile(FISIER_DATE):
        noua_linie.to_csv(FISIER_DATE, index=False)
    else:
        # DacÄƒ existÄƒ, adÄƒugÄƒm la final (append)
        noua_linie.to_csv(FISIER_DATE, mode='a', header=False, index=False)

# 4. InterfaÈ›a Utilizatorului
st.title("ğŸ“‹ Foaie de Parcurs AutomatÄƒ")
st.write("Ãnregistrare traseu zilnic")

# Data È™i ora curentÄƒ (se completeazÄƒ singure)
data_acum = datetime.now().strftime("%d-%m-%Y %H:%M")
st.info(f"ğŸ“… Data curentÄƒ: {data_acum}")

# IntrÄƒri de date
km_start = st.number_input("Introdu KM la plecare (bord):", min_value=0, step=1)
traseu = st.text_input("Traseu (ex: Str. A > Str. B):")

# Logica pentru ora 17:00
ora_actuala = datetime.now().hour
km_final = 0

if ora_actuala >= 17:
    st.warning("ğŸŒ™ Este dupÄƒ ora 17:00. Te rugÄƒm sÄƒ Ã®nchizi foaia de parcurs.")
    km_final = st.number_input("Introdu KM la sosire (bord):", min_value=km_start, step=1)
else:
    st.info("â„¹ï¸ CÃ¢mpul pentru KM Final va apÄƒrea automat dupÄƒ ora 17:00.")

# 5. Butonul de Salvare
if st.button("âœ… SalveazÄƒ Ã®nregistrarea"):
    if traseu == "":
        st.error("âš ï¸ Te rugÄƒm sÄƒ introduci traseul Ã®nainte de a salva!")
    else:
        adauga_inregistrare(data_acum, km_start, traseu, km_final)
        st.success("ğŸ’¾ Datele au fost salvate cu succes!")

st.divider()

# 6. Vizualizare È™i DescÄƒrcare Istoric
st.subheader("ğŸ“Š Istoric Ã®nregistrÄƒri")

if os.path.isfile(FISIER_DATE):
    # Citim datele pentru a le arÄƒta Ã®n tabel
    df = pd.read_csv(FISIER_DATE)
    st.dataframe(df, use_container_width=True)
    
    # Buton de descÄƒrcare fiÈ™ier pentru Excel
    with open(FISIER_DATE, "rb") as file:
        st.download_button(
            label="ğŸ“¥ DescarcÄƒ fiÈ™ierul CSV pentru Excel",
            data=file,
            file_name=f"Foaie_Parcurs_{datetime.now().strftime('%m_%Y')}.csv",
            mime="text/csv"
        )
else:
    st.write("Nu existÄƒ Ã®nregistrÄƒri salvate Ã®ncÄƒ.")
